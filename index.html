<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .main-container { display: flex; gap: 20px; align-items: flex-start; max-width: 1250px; }
        .controls { background: #2d2d2d; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; border: 1px solid #444; width: 950px; }
        .item { display: flex; flex-direction: column; gap: 5px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; }
        .val-out { font-size: 10px; color: #ffc107; font-family: monospace; }
        
        .sidebar { background: #2d2d2d; padding: 15px; border-radius: 8px; border: 1px solid #444; min-width: 220px; max-height: 600px; overflow-y: auto; }
        .sidebar h3 { margin-top: 0; font-size: 14px; color: #ffc107; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .stat-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 11px; }
        .color-swatch { width: 14px; height: 14px; border-radius: 2px; border: 1px solid #555; }
        
        .gallery { display: flex; gap: 10px; margin-bottom: 15px; background: #2d2d2d; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .pattern-thumb { width: 60px; height: 60px; border: 2px solid #555; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #1a1a1a; transition: 0.2s; }
        .pattern-thumb.active { border-color: #ffc107; background: #333; }
        .pattern-thumb svg { width: 40px; height: 40px; stroke: #a67c52; fill: none; stroke-width: 2; }

        input, select, button { background: #444; color: white; border: 1px solid #555; padding: 5px; border-radius: 4px; }
        button { background: #4a6fa5; cursor: pointer; grid-column: span 4; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #3b5984; }
        canvas { border: 1px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div class="gallery" id="patternGallery">
        <div class="pattern-thumb active" data-value="asanoha" title="Asanoha">
            <svg viewBox="0 0 40 40"><path d="M20,5 L5,30 L35,30 Z M20,5 L20,30 M5,30 L27.5,17.5 M35,30 L12.5,17.5 M20,21.5 L20,30 M12.5,25 L20,21.5 L27.5,25"/></svg>
        </div>
        <div class="pattern-thumb" data-value="sakura" title="Sakura">
            <svg viewBox="0 0 40 40"><path d="M20,20 L20,5 M20,20 L33,28 M20,20 L7,28 M20,10 L25,5 L15,5 L20,10 M30,22 L35,28 L30,33 L30,22 M10,22 L5,28 L10,33 L10,22"/></svg>
        </div>
        <div class="pattern-thumb" data-value="shippo" title="Kaku-Shippo">
            <svg viewBox="0 0 40 40"><path d="M20,5 L5,30 L35,30 Z M20,5 L12.5,21.5 L20,30 L27.5,21.5 L20,5"/></svg>
        </div>
        <div class="pattern-thumb" data-value="goma" title="Goma">
            <svg viewBox="0 0 40 40"><path d="M20,5 L16,15 L24,15 L20,5 Z"/></svg>
        </div>
    </div>

    <div class="controls">
        <div class="item">
            <label>1. Photo</label>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        <div class="item">
            <div class="label-row"><label>2. Color Steps</label><span class="val-out" id="v-colorSlider">8</span></div>
            <input type="range" id="colorSlider" min="2" max="15" value="8">
        </div>
        <div class="item">
            <div class="label-row"><label>3. Density (Scroll)</label><span class="val-out" id="v-triSlider">35</span></div>
            <input type="range" id="triSlider" min="10" max="100" value="35">
        </div>
        <div class="item">
            <div class="label-row"><label>4. Contrast</label><span class="val-out" id="v-contrastSlider">1.2</span></div>
            <input type="range" id="contrastSlider" min="1" max="3" step="0.1" value="1.2">
        </div>
        <div class="item">
            <div class="label-row"><label>5. Grid Weight</label><span class="val-out" id="v-gridThick">1.0</span></div>
            <input type="range" id="gridThick" min="0.1" max="5" step="0.1" value="1.0">
        </div>
        <div class="item">
            <div class="label-row"><label>6. Pattern Weight</label><span class="val-out" id="v-patThick">1.5</span></div>
            <input type="range" id="patThick" min="0.1" max="5" step="0.1" value="1.5">
        </div>
        <div class="item">
            <label>7. Grid Color</label>
            <input type="color" id="framePicker" value="#a67c52">
        </div>
        <div class="item">
            <label>8. Void Color</label>
            <input type="color" id="bgPicker" value="#000033">
        </div>
        <button id="saveBtn">Save as PNG</button>
    </div>

    <div class="main-container">
        <div id="canvas-holder"></div>
        <div class="sidebar">
            <h3>Summary</h3>
            <div id="stats-content">Upload an image...</div>
        </div>
    </div>

    <script>
        let img;
        let isReady = false;
        let targetColor = [0, 0, 51];
        let currentPattern = 'asanoha';

        function setup() {
            let cnv = createCanvas(800, 600);
            cnv.parent('canvas-holder');
            pixelDensity(2);
            noLoop();
            cnv.mouseWheel(changeDensity);

            document.getElementById('fileInput').addEventListener('change', handleUpload);
            
            document.querySelectorAll('.pattern-thumb').forEach(thumb => {
                thumb.addEventListener('click', () => {
                    document.querySelector('.pattern-thumb.active').classList.remove('active');
                    thumb.classList.add('active');
                    currentPattern = thumb.getAttribute('data-value');
                    redraw();
                });
            });

            document.querySelectorAll('input').forEach(el => {
                el.addEventListener('input', () => {
                    if (el.id === 'bgPicker') {
                        let hexVal = el.value;
                        targetColor = [parseInt(hexVal.slice(1,3), 16), parseInt(hexVal.slice(3,5), 16), parseInt(hexVal.slice(5,7), 16)];
                    }
                    let display = document.getElementById('v-' + el.id);
                    if (display) display.innerText = el.value;
                    redraw();
                });
            });

            document.getElementById('saveBtn').addEventListener('click', () => saveCanvas('kumiko_design', 'png'));
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                loadImage(event.target.result, loadedImg => {
                    img = loadedImg;
                    img.loadPixels();
                    resizeCanvas(800, 800 * (img.height / img.width));
                    isReady = true;
                    redraw();
                });
            };
            reader.readAsDataURL(file);
        }

        function changeDensity(event) {
            let slider = document.getElementById('triSlider');
            let val = parseInt(slider.value);
            if (event.deltaY > 0) val = max(10, val - 1);
            else val = min(100, val + 1);
            slider.value = val;
            document.getElementById('v-triSlider').innerText = val;
            redraw();
            return false;
        }

        function draw() {
            background(targetColor);
            let numTriW = parseInt(document.getElementById('triSlider').value);
            let sideLen = width / numTriW;
            let h = (sqrt(3) / 2) * sideLen;
            let rows = ceil(height / h) + 2;
            let colorSteps = parseInt(document.getElementById('colorSlider').value);
            let gridCol = document.getElementById('framePicker').value;
            let gridWt = parseFloat(document.getElementById('gridThick').value);
            let patWt = parseFloat(document.getElementById('patThick').value);
            let contrast = parseFloat(document.getElementById('contrastSlider').value);

            let colorCounts = {};

            // --- PASS 1: GLOBAL MESH FRAME ---
            stroke(gridCol);
            strokeWeight(gridWt);
            noFill();
            for (let r = 0; r <= rows; r++) line(0, r * h, width, r * h);
            for (let r = 0; r < rows; r++) {
                let y = r * h;
                for (let c = 0; c < (numTriW * 2) + 2; c++) {
                    if ((r + c) % 2 === 0) {
                        line(c * sideLen/2, y, (c-1) * sideLen/2, y + h);
                        line(c * sideLen/2, y, (c+1) * sideLen/2, y + h);
                    }
                }
            }

            // --- PASS 2: CENTERED PATTERNS WITH PADDING ---
            if (isReady && img) {
                strokeWeight(patWt);
                strokeCap(ROUND);
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < numTriW * 2; c++) {
                        let x = c * (sideLen / 2);
                        let isUp = (r + c) % 2 === 0;
                        let cy = r * h + (isUp ? h/3 * 2 : h/3); 
                        
                        let sx = floor(map(x, 0, width, 0, img.width));
                        let sy = floor(map(cy, 0, height, 0, img.height));
                        let pCol = img.get(sx, sy);
                        
                        let rq = floor(constrain(pCol[0] * contrast, 0, 255) / (256/colorSteps)) * (256/colorSteps);
                        let gq = floor(constrain(pCol[1] * contrast, 0, 255) / (256/colorSteps)) * (256/colorSteps);
                        let bq = floor(constrain(pCol[2] * contrast, 0, 255) / (256/colorSteps)) * (256/colorSteps);
                        let hexStr = "#" + hex(rq,2) + hex(gq,2) + hex(bq,2);

                        if (dist(rq, gq, bq, targetColor[0], targetColor[1], targetColor[2]) > 40) {
                            stroke(rq, gq, bq);
                            renderPattern(currentPattern, x, cy, sideLen, h, isUp, gridWt);
                            colorCounts[hexStr] = (colorCounts[hexStr] || 0) + 1;
                        }
                    }
                }
                updateSidebar(colorCounts);
            }
        }

        function updateSidebar(counts) {
            let container = document.getElementById('stats-content');
            let sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            let total = 0;
            let html = `<strong>Pattern:</strong> ${currentPattern.toUpperCase()}<br><br>`;
            for (let [color, count] of sorted) {
                html += `<div class="stat-item"><div class="color-swatch" style="background:${color}"></div><span>${color}: <strong>${count}</strong></span></div>`;
                total += count;
            }
            html += `<br><strong>Total Pieces: ${total}</strong>`;
            container.innerHTML = html;
        }

        function renderPattern(type, x, cy, s, h, isUp, pad) {
            let gap = pad * 1.5; 
            let s_pad = s - (gap * 2.3); 
            let h_pad = (sqrt(3) / 2) * s_pad;
            
            let tipY = isUp ? -h_pad/3 * 2 : h_pad/3 * 2;
            let baseY = isUp ? h_pad/3 : -h_pad/3;

            if (type === 'asanoha') {
                line(x, cy + tipY, x, cy); 
                line(x - s_pad/2, cy + baseY, x, cy); 
                line(x + s_pad/2, cy + baseY, x, cy);
                line(x - s_pad/4, cy + (tipY + baseY)/2, x, cy); 
                line(x + s_pad/4, cy + (tipY + baseY)/2, x, cy); 
                line(x, cy + baseY, x, cy);
            } else if (type === 'sakura') {
                for(let i=0; i<3; i++) {
                    let ang = TWO_PI/3 * i + (isUp ? PI/6 : -PI/6);
                    let px = x + cos(ang) * s_pad/3;
                    let py = cy + sin(ang) * s_pad/3;
                    line(x, cy, px, py);
                    line(px, py, x + cos(ang+0.5) * s_pad/2, cy + sin(ang+0.5) * s_pad/2);
                    line(px, py, x + cos(ang-0.5) * s_pad/2, cy + sin(ang-0.5) * s_pad/2);
                }
            } else if (type === 'shippo') {
                line(x, cy + tipY, x - s_pad/4, cy); line(x, cy + tipY, x + s_pad/4, cy);
                line(x, cy + baseY, x - s_pad/4, cy); line(x, cy + baseY, x + s_pad/4, cy);
            } else if (type === 'goma') {
                // FIXED: GOMA CLOSED TRIANGLE
                let midY = cy + (tipY + baseY) / 2.5; 
                let sideX = s_pad / 4;
                line(x, cy + tipY, x - sideX, midY);
                line(x, cy + tipY, x + sideX, midY);
                line(x - sideX, midY, x + sideX, midY); // Closed base of sesame
            }
        }
        
        function mousePressed() {
            if (isReady && img && mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
                let p = img.get(floor(map(mouseX, 0, width, 0, img.width)), floor(map(mouseY, 0, height, 0, img.height)));
                targetColor = [p[0], p[1], p[2]];
                document.getElementById('bgPicker').value = "#" + hex(p[0],2) + hex(p[1],2) + hex(p[2],2);
                redraw();
            }
        }
    </script>
</body>
</html>